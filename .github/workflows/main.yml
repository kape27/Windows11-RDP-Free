name: RDP
on:
  workflow_dispatch:

jobs:
  build:
    name: Start Building
    runs-on: windows-latest
    timeout-minutes: 9999
    steps:
    - name: Downloading & Installing Essentials
      run: |
        choco install -y ngrok
        
    - name: Enable RDP Access
      run: |
        # Enable RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0 -Force
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
        
        # Enable MultiUser Session
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1 -Force
        
    - name: Setup Tailscale with Auth Key
      env:
        TS_AUTH_KEY: ${{ secrets.TS_AUTHKEY }}
      run: |
        choco install -y tailscale
        & 'C:\Program Files\Tailscale\tailscale.exe' up --authkey=$env:TS_AUTH_KEY --accept-dns=false
        
    - name: Get RDP Connection Details
      run: |
        echo "RDP Setup Complete!"
        echo "Getting Tailscale IP..."
        & 'C:\Program Files\Tailscale\tailscale.exe' ip -4
        
    - name: Maintain RDP Connection
      run: |
        while ($true) { 
          Start-Sleep -Seconds 300
        }
